let _notesElement=document.getElementById("notes"),_id,_scale=1,_isMove=!1,_isResize=!1,_isModalOpen=!1,_isErrorDialogOpen=!1,_currentX=100,_currentY=100,_endX,_endY,_sourceElement=undefined,_selectedElement=undefined,_pointers=[],_pointerDiff=0,_updateSend=new Date,_coordinateAdjustX=0,_coordinateAdjustY=0,_imported=!1;const showErrorDialog=()=>{if(!_isErrorDialogOpen){_isErrorDialogOpen=!0;const n=document.getElementById("errorModal"),t=new bootstrap.Modal(n);t.show()}},generateId=()=>{try{const n=window.crypto.getRandomValues(new Uint32Array(4));return n[0].toString(16)+"-"+n[1].toString(16)+"-"+n[2].toString(16)+"-"+n[3].toString(16)}catch(n){return console.log("Secure random number generation is not supported."),Math.floor(Math.random()*1e10).toString()}},parseQueryString=()=>{let n=new Map;const t=document.location.search.substring(1),i=t.split("&");return i.forEach(t=>{const i=t.split("=");n.set(i[0],i[1])}),n},getId=()=>{if(document.location.search!==""){_imported=!0;const t=parseQueryString(),n=t.get("import");if(n!==undefined){console.log(n);const t=await fetch(n);if(t.status===200){console.log(t.status);const n=await t.json();console.log(n);importNotes(n);zoomOut(n)}}return}_id=document.location.hash.replace("#","");_id.length===0&&(_id=generateId(),document.location.hash=_id);document.querySelector('meta[property="og:url"]').setAttribute("content",document.location.href)};getId();window.addEventListener("hashchange",n=>{n.oldURL.indexOf("#")!=-1&&(console.log("hashchange event occured!"),connection.invoke("Leave",_id).then(function(){console.log("Leave called");getId();console.log(_id);const n=document.getElementsByClassName("stickynote");while(n.length>0)_notesElement.removeChild(n[0]);_selectedElement=_selectedElement=undefined;_pointers=[];_scale=1;_isMove=!1;_isResize=!1;_isModalOpen=!1;_coordinateAdjustX=_coordinateAdjustY=0;connection.invoke("Join",_id)}).catch(function(n){console.log("Leave error");console.log(n);showErrorDialog()}))});const deSelectNotes=()=>{const n=document.getElementsByClassName("selected");while(n.length>0)n[0].classList.remove("selected")},pointerDown=n=>{if(!_isModalOpen){_pointers.push(n);_currentX=n.clientX/_scale;_currentY=n.clientY/_scale;const t=n.srcElement.offsetWidth,i=n.srcElement.offsetHeight;n.ctrlKey||deSelectNotes();_selectedElement=_sourceElement=n.srcElement;_sourceElement.className="stickynote selected";_isResize=n.offsetX>=t*.7&&n.offsetY>=i*.6;n.stopPropagation()}},convertElementToNote=n=>{const t=n.offsetLeft,i=n.offsetTop,r=Math.floor(n.style.zIndex),u=Math.floor(n.style.width.replace("px","")),f=Math.floor(n.style.height.replace("px","")),e=Math.floor(n.style.transform.replace("rotateZ(","").replace("deg)",""));return{id:n.id,text:n.innerText,link:n.dataset.link,color:n.style.backgroundColor,position:{x:t+_coordinateAdjustX,y:i+_coordinateAdjustY,z:r,rotation:e},width:u,height:f}},importNotes=n=>{if(n!==undefined&&n.length!==undefined){const t=[];for(let i=0;i<n.length;i++){const r=n[i];r.id=generateId();r.position.x+=100;r.position.y+=100;r.position.rotation=Math.floor(Math.random()*8)-4;let u=document.createElement("div");createOrUpdateNoteElement(u,r);_notesElement.insertBefore(u,_notesElement.firstChild);t.push(u)}t.length>0&&updateNoteElementsToServer(t)}},updateNoteElementsToServer=n=>{if(!_imported){let t=[];for(let i=0;i<n.length;i++){const r=n[i];let u=convertElementToNote(r);t.push(u)}connection.invoke("UpdateNotes",_id,t).then(function(){console.log("updateNoteMove called",t)}).catch(function(n){console.log("updateNoteMove error");console.log(n);showErrorDialog()})}},pointerMove=n=>{if(n.stopPropagation(),!_isModalOpen){const t=n.clientX/_scale,i=n.clientY/_scale;for(let t=0;t<_pointers.length;t++)if(_pointers[t].pointerId==n.pointerId){_pointers[t]=n;break}if(_pointers.length>1){if(_pointers.length===2){const n=Math.abs(_pointers[0].clientX-_pointers[1].clientX),t=Math.abs(_pointers[0].clientY-_pointers[1].clientY),i=Math.sqrt(n*n+t*t);if(_pointerDiff>0){const e=_pointerDiff-i,o=_scale;_scale+=e*-.002;_scale=Math.min(Math.max(.1,_scale),10);_notesElement.style.transform=`scale(${_scale})`;const t=o-_scale,r=document.documentElement.clientWidth/_scale/2,s=document.documentElement.clientHeight/_scale/2,n=Math.floor(r*t),u=Math.floor(s*t);console.table({centerX:r,correctionX:n,scaleChange:t,correctionX:n,_scale});_coordinateAdjustX-=n;_coordinateAdjustY-=u;const f=document.getElementsByClassName("stickynote");for(let t=0;t<f.length;t++){const i=f[t];i.style.left=`${i.offsetLeft+n}px`;i.style.top=`${i.offsetTop+u}px`}}_pointerDiff=i}return}if(_endX=Math.floor(_currentX-t),_endY=Math.floor(_currentY-i),_currentX=t,_currentY=i,_sourceElement===undefined){if(_isMove){_coordinateAdjustX+=_endX;_coordinateAdjustY+=_endY;const n=document.getElementsByClassName("stickynote");for(let t=0;t<n.length;t++){const i=n[t];i.style.left=`${i.offsetLeft-_endX}px`;i.style.top=`${i.offsetTop-_endY}px`}}return}if(_isResize){const n=Math.floor(_sourceElement.style.width.replace("px","")),t=Math.floor(_sourceElement.style.height.replace("px",""));_sourceElement.style.width=`${n-_endX}px`;_sourceElement.style.height=`${t-_endY}px`;new Date-_updateSend>80&&(updateNoteElementsToServer([_sourceElement]),_updateSend=new Date)}else{const n=document.getElementsByClassName("selected");for(let t=0;t<n.length;t++){const i=n[t];i.style.left=`${i.offsetLeft-_endX}px`;i.style.top=`${i.offsetTop-_endY}px`}new Date-_updateSend>80&&(updateNoteElementsToServer(n),_updateSend=new Date)}}},pointerUp=n=>{_isMove=!1;for(let t=0;t<_pointers.length;t++){const i=_pointers[t];if(i.pointerId==n.pointerId){_pointers.splice(t,1);break}}if(_sourceElement!==undefined){const n=document.getElementsByClassName("selected");updateNoteElementsToServer(n)}_sourceElement=undefined;n.stopPropagation()};window.addEventListener("pointermove",pointerMove,{passive:!0});window.addEventListener("pointerup",pointerUp);window.addEventListener("wheel",n=>{if(n.stopPropagation(),!_isModalOpen){const e=_scale;_scale+=n.deltaY*-.001;_scale=Math.min(Math.max(.1,_scale),10);_notesElement.style.transform=`scale(${_scale})`;const i=e-_scale,r=n.clientX/_scale,o=n.clientY/_scale,t=Math.floor(r*i),u=Math.floor(o*i);console.table({centerX:r,correctionX:t,scaleChange:i,correctionX:t,_scale});_coordinateAdjustX-=t;_coordinateAdjustY-=u;const f=document.getElementsByClassName("stickynote");for(let n=0;n<f.length;n++){const i=f[n];i.style.left=`${i.offsetLeft+t}px`;i.style.top=`${i.offsetTop+u}px`}}});let protocol=new signalR.JsonHubProtocol,hubRoute="Notes",connection=(new signalR.HubConnectionBuilder).withUrl(hubRoute).withAutomaticReconnect().withHubProtocol(protocol).build();const editNoteMenu=(n,t)=>{const i=document.getElementById("colorModal"),r=document.getElementById("noteText"),u=document.getElementById("noteLink"),f=document.getElementById("noteColor"),e=document.getElementById("updateNoteSaveButton"),o=()=>{c.hide();const i=r.value!==n.innerText;if(t.text=n.innerText=r.value,t.link=n.dataset.link=u.value,t.color=n.style.backgroundColor=f.value,i){console.log("Re-calculate the size due to text update");const i=calculateNoteSize(t.text);n.style.width=`${i.width}px`;n.style.height=`${i.height}px`}updateNoteElementsToServer([n])},s=()=>{_isModalOpen=!0,r.focus()},h=()=>{_isModalOpen=!1,e.removeEventListener("click",o),i.removeEventListener("shown.bs.modal",s),i.removeEventListener("hidden.bs.modal",h)};e.addEventListener("click",o);i.addEventListener("shown.bs.modal",s);i.addEventListener("hidden.bs.modal",h);r.value=t.text;u.value=t.link;f.value=t.color;const c=new bootstrap.Modal(i);c.show()},createOrUpdateNoteElement=(n,t)=>{n.id=t.id,n.innerText=t.text,n.dataset.link=t.link,n.className="stickynote",n.style.backgroundColor=t.color,n.style.left=`${t.position.x}px`,n.style.top=`${t.position.y}px`,n.style.zIndex=t.position.z,n.style.transform=`rotateZ(${t.position.rotation}deg)`,n.style.width=`${t.width}px`,n.style.height=`${t.height}px`,n.addEventListener("pointerdown",pointerDown,{passive:!0}),n.addEventListener("dblclick",()=>{_pointers=[],editNoteMenu(n,t)}),n.addEventListener("contextmenu",i=>{_pointers=[];i.preventDefault();i.stopPropagation();_isModalOpen=!0;const u=document.getElementById("noteMenuModal"),e=document.getElementById("noteMenuOpenLink"),o=document.getElementById("noteMenuEditNote"),s=document.getElementById("noteMenuDeleteNote");let f=!1;const h=()=>{r.hide(),f=!0,_isModalOpen=!1,t.link!==undefined&&t.link!==""&&(document.location.href=t.link)},c=()=>{r.hide(),f=!0,_isModalOpen=!1,editNoteMenu(n,t)},l=()=>{r.hide(),console.log(t.id),confirm("Do you really want to delete this note?")&&(connection.invoke("DeleteNotes",_id,[t.id]).then(function(){console.log("DeleteNotes called")}).catch(function(n){console.log("DeleteNotes error");console.log(n)}),_notesElement.removeChild(n))},a=()=>{f||(_isModalOpen=!1),e.removeEventListener("click",h),o.removeEventListener("click",c),s.removeEventListener("click",l),u.removeEventListener("hidden.bs.modal",a)};e.addEventListener("click",h);o.addEventListener("click",c);s.addEventListener("click",l);u.addEventListener("hidden.bs.modal",a);const r=new bootstrap.Modal(u);r.show()})},calculateNoteSize=n=>{let t=100,r=100;const i=n.split(/\r\n|\r|\n/);for(let n=0;n<i.length;n++){const u=i[n];let r=u.length*17;t<r&&(t=r)}return r=Math.max(100,32*i.length),console.log({lines:i.length,height:r,width:t}),{width:t,height:r}},addNote=(n,t,i)=>{const u=calculateNoteSize(n);let f={id:generateId(),text:n,link:t,color:i,position:{x:_currentX-100+200*Math.random(),y:_currentY-100+200*Math.random(),z:100,rotation:Math.floor(Math.random()*8)-4},width:u.width,height:u.height},r=document.createElement("div");createOrUpdateNoteElement(r,f);_notesElement.insertBefore(r,_notesElement.firstChild);updateNoteElementsToServer([r])},deleteAllNotesByClassFilter=(n,t)=>{const i=document.getElementsByClassName(n);let r=[];while(i.length>0)r.push(i[0].id),_notesElement.removeChild(i[0]);t&&connection.invoke("DeleteNotes",_id,r).then(function(){console.log("DeleteNotes by filter called")}).catch(function(n){console.log("DeleteNotes by filter error");console.log(n);showErrorDialog()});_selectedElement=undefined},showNoteDialog=()=>{if(_isMove=!1,_pointers=[],!_isModalOpen){_isModalOpen=!0;const t=document.getElementById("colorModal"),n=document.getElementById("noteText"),u=document.getElementById("noteLink"),i=document.getElementById("noteColor"),f=document.getElementById("updateNoteSaveButton");n.value="";i.value="lightyellow";let r=[];const e=()=>{n.value.length!==0?(r.push({text:n.value,link:u.value,color:i.value}),n.value="",u.value="",i.value="lightyellow",n.focus()):h.hide()},o=()=>{n.focus()},s=()=>{_isModalOpen=!1;f.removeEventListener("click",e);t.removeEventListener("shown.bs.modal",o);t.removeEventListener("hidden.bs.modal",s);for(let n=0;n<r.length;n++){const t=r[n];addNote(t.text,t.link,t.color)}};f.addEventListener("click",e);t.addEventListener("shown.bs.modal",o);t.addEventListener("hidden.bs.modal",s);const h=new bootstrap.Modal(t);h.show()}};window.addEventListener("focus",()=>{connection.state==="Disconnected"&&startConnection()});window.addEventListener("blur",()=>{});window.addEventListener("pointerdown",n=>{_isModalOpen||(deSelectNotes(),_pointerDiff=0,_pointers.push(n),_currentX=n.clientX/_scale,_currentY=n.clientY/_scale,_isMove=!0)});window.addEventListener("contextmenu",n=>{if(n.preventDefault(),_sourceElement===undefined){_isModalOpen=!0;const t=document.getElementById("menuModal"),i=document.getElementById("menuAddNotes"),r=document.getElementById("menuZoomOut"),u=document.getElementById("menuStartNewSession"),f=document.getElementById("menuRemoveAllNotes");let e=!1;const o=()=>{n.hide(),e=!0,_isModalOpen=!1,showNoteDialog()},s=()=>{n.hide(),document.location.reload()},h=()=>{n.hide(),_id=generateId(),document.location.hash=_id},c=()=>{n.hide(),confirm("Do you really want to delete all notes?")&&deleteAllNotesByClassFilter("stickynote",!0)},l=()=>{e||(_isModalOpen=!1),i.removeEventListener("click",o),r.removeEventListener("click",s),u.removeEventListener("click",h),f.removeEventListener("click",c),t.removeEventListener("hidden.bs.modal",l)};i.addEventListener("click",o);r.addEventListener("click",s);u.addEventListener("click",h);f.addEventListener("click",c);t.addEventListener("hidden.bs.modal",l);const n=new bootstrap.Modal(t);n.show()}});connection.onclose(n=>{console.log(`onclose: ${n}`)});connection.onreconnecting(n=>{console.log(`onreconnecting : ${n}`)});connection.onreconnected(n=>{console.log(`onreconnected : ${n}`),connection.invoke("Join",_id)});const startConnection=()=>{_imported||connection.start().then(function(){connection.invoke("Join",_id)}).catch(function(n){console.log(n);showErrorDialog()})},zoomOut=n=>{deleteAllNotesByClassFilter("stickynote",!1);let t=9999999999,o=-9999999999,i=9999999999,s=-9999999999;for(let r=0;r<n.length;r++){const u=n[r];u.position.x<t&&(t=u.position.x);u.position.x+u.width>o&&(o=u.position.x+u.width);u.position.y<i&&(i=u.position.y);u.position.y+u.height>s&&(s=u.position.y+u.height)}const f=Math.abs(o-t)+40,e=Math.abs(s-i)+40,r=document.documentElement.clientWidth/f,u=document.documentElement.clientHeight/e;r<1&&r<u?(console.log("scale x axes: "+r),_scale=r,_coordinateAdjustX=t-20-(document.documentElement.clientWidth-f*_scale)/2,_coordinateAdjustY=i-20-(document.documentElement.clientHeight-e*_scale)/2):u<1&&u<=r?(console.log("scale y axes: "+u),_scale=u,_coordinateAdjustX=t-20-(document.documentElement.clientWidth-f*_scale)/2,_coordinateAdjustY=i-20-(document.documentElement.clientHeight-e*_scale)/2):(console.log("no scale required, centering"),_scale=1,_coordinateAdjustX=t-document.documentElement.clientWidth/2+f/2,_coordinateAdjustY=i-document.documentElement.clientHeight/2+e/2);for(let t=0;t<n.length;t++){const i=n[t];i.position.x-=_coordinateAdjustX;i.position.y-=_coordinateAdjustY;const r=document.createElement("div");createOrUpdateNoteElement(r,i);_notesElement.insertBefore(r,_notesElement.firstChild)}_notesElement.style.transform=`scale(${_scale})`};connection.on("AllNotes",n=>{console.log("Notes:"),console.log(n),zoomOut(n)});connection.on("UpdateNotes",n=>{console.log("UpdateNotes:");console.log(n);for(let t=0;t<n.length;t++){const r=n[t];r.position.x-=_coordinateAdjustX;r.position.y-=_coordinateAdjustY;let i=document.getElementById(r.id);i===undefined||i==null?(i=document.createElement("div"),createOrUpdateNoteElement(i,r),_notesElement.insertBefore(i,_notesElement.firstChild)):createOrUpdateNoteElement(i,r)}});connection.on("DeleteNotes",n=>{console.log("DeleteNotes:");console.log(n);for(let t=0;t<n.length;t++){const r=n[t],i=document.getElementById(r);i&&_notesElement.removeChild(i)}});document.addEventListener("keyup",n=>{if(n.key==="Escape")deSelectNotes(),_selectedElement=undefined;else if(!_isModalOpen)if(n.ctrlKey&&n.key==="c"){const n=document.getElementsByClassName("selected"),t=[];for(let i=0;i<n.length;i++){const r=n[i];t.push(convertElementToNote(r))}const i=JSON.stringify(t);navigator.clipboard.writeText(i).then(()=>{},()=>{sessionStorage.setItem("copy",i)})}else if(n.ctrlKey&&n.key==="v"){let n;navigator.clipboard.readText().then(t=>{n=t},()=>{n=sessionStorage.getItem("copy")}).then(()=>{const t=JSON.parse(n);importNotes(t)})}else if(n.key!=="Alt"&&n.key!=="Control"&&n.key!=="F12"&&n.key!=="Tab"&&(!n.ctrlKey||n.key!=="w"&&n.key!=="r")&&(!n.shiftKey||n.key!=="s"))if(n.key==="Backspace"||n.key==="Delete")deleteAllNotesByClassFilter("selected",!0);else if(n.key==="a"&&n.ctrlKey){deSelectNotes();const n=document.getElementsByClassName("stickynote");for(let t=0;t<n.length;t++)n[t].classList.add("selected")}else n.key==="0"&&n.ctrlKey?(_scale=1,_notesElement.style.transform=`scale(${_scale})`):n.altKey||(console.log(n),showNoteDialog())});document.getElementById("noteText").addEventListener("keyup",n=>{n.key==="Enter"&&n.ctrlKey&&document.getElementById("updateNoteSaveButton").click()});let lockResolver;if(navigator&&navigator.locks&&navigator.locks.request){console.log("Browser supports Web Locks API. Trying to prevent tab from sleeping.");const n=new Promise(n=>{lockResolver=n});navigator.locks.request("stickynotes",{mode:"shared"},()=>n)}startConnection();