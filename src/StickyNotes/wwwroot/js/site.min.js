function showHelp(){document.getElementById("helpOpen").style.display="none";document.getElementById("helpClose").style.display="";document.getElementById("help").style.display=""}function hideHelp(){document.getElementById("helpOpen").style.display="";document.getElementById("helpClose").style.display="none";document.getElementById("help").style.display="none"}let notesElement=document.getElementById("notes"),scale=1,isMove=!1,isResize=!1,isModalOpen=!1,currentX,currentY,endX,endY,sourceElement=undefined,selectedElement=undefined,pointers=[],pointerDiff=0,updateSend=new Date;const generateId=()=>{try{const n=window.crypto.getRandomValues(new Uint32Array(4));return n[0].toString(16)+"-"+n[1].toString(16)+"-"+n[2].toString(16)+"-"+n[3].toString(16)}catch(n){return console.log("Secure random number generation is not supported."),Math.floor(Math.random()*1e10).toString()}},getId=()=>{let n=document.location.hash.replace("#","");return n.length===0&&(n=generateId(),document.location.hash=n),n},id=getId();console.log(id);const deSelectNotes=()=>{const n=document.getElementsByClassName("selected");while(n.length>0)n[0].classList.remove("selected")},pointerDown=n=>{pointers.push(n);currentX=n.clientX;currentY=n.clientY;const t=n.srcElement.offsetWidth,i=n.srcElement.offsetHeight;deSelectNotes();selectedElement=sourceElement=n.srcElement;sourceElement.className="stickynote selected";isResize=n.offsetX>=t*.7&&n.offsetY>=i*.7;n.stopPropagation()},updateNoteMove=n=>{const t=Math.floor(n.style.top.replace("px","")),i=Math.floor(n.style.left.replace("px","")),r=Math.floor(n.style.width.replace("px","")),u=Math.floor(n.style.height.replace("px","")),f=Math.floor(n.style.transform.replace("rotateZ(","").replace("deg)",""));let e={id:n.id,text:n.innerText,color:n.style.backgroundColor,position:{x:t,y:i,rotation:f},width:r,height:u};connection.invoke("UpdateNote",id,e).then(function(){console.log("updateNoteMove called")}).catch(function(n){console.log("updateNoteMove error");console.log(n)})},pointerMove=n=>{n.stopPropagation();for(let t=0;t<pointers.length;t++)if(pointers[t].pointerId==n.pointerId){pointers[t]=n;break}if(pointers.length>1){if(console.log("handle gesture: "+pointers.length),pointers.length===2){const n=Math.abs(pointers[0].clientX-pointers[1].clientX),t=Math.abs(pointers[0].clientY-pointers[1].clientY),i=Math.sqrt(n*n+t*t);if(pointerDiff>0){const n=pointerDiff-i;scale+=n*-.001;scale=Math.min(Math.max(.1,scale),10);notesElement.style.transform=`scale(${scale})`}pointerDiff=i}return}if(sourceElement===undefined){if(isMove){endX=currentX-n.clientX;endY=currentY-n.clientY;currentX=n.clientX;currentY=n.clientY;const t=document.getElementsByClassName("stickynote");for(let n=0;n<t.length;n++){const i=t[n];i.style.top=`${i.offsetTop-endY}px`;i.style.left=`${i.offsetLeft-endX}px`}}return}if(endX=currentX-n.clientX,endY=currentY-n.clientY,currentX=n.clientX,currentY=n.clientY,isResize){const n=Math.floor(sourceElement.style.width.replace("px","")),t=Math.floor(sourceElement.style.height.replace("px",""));sourceElement.style.width=`${n-endX}px`;sourceElement.style.height=`${t-endY}px`}else sourceElement.style.top=`${sourceElement.offsetTop-endY}px`,sourceElement.style.left=`${sourceElement.offsetLeft-endX}px`;new Date-updateSend>20&&(updateNoteMove(sourceElement),updateSend=new Date)},pointerUp=n=>{isMove=!1;for(let t=0;t<pointers.length;t++){const i=pointers[t];if(i.pointerId==n.pointerId){pointers.splice(t,1);break}}sourceElement!==undefined&&updateNoteMove(sourceElement);sourceElement=undefined;n.stopPropagation()};window.addEventListener("pointermove",pointerMove,{passive:!0});window.addEventListener("pointerup",pointerUp);window.addEventListener("wheel",n=>{scale+=n.deltaY*-.001,scale=Math.min(Math.max(.1,scale),10),notesElement.style.transform=`scale(${scale})`});let protocol=new signalR.JsonHubProtocol,hubRoute="Notes",connection=(new signalR.HubConnectionBuilder).withUrl(hubRoute).withAutomaticReconnect().withHubProtocol(protocol).build();const createOrUpdateNoteElement=(n,t)=>{n.id=t.id,n.innerText=t.text,n.className="stickynote",n.style.backgroundColor=t.color,n.style.top=`${t.position.x}px`,n.style.left=`${t.position.y}px`,n.style.transform=`rotateZ(${t.position.rotation}deg)`,n.style.width=`${t.width}px`,n.style.height=`${t.height}px`,n.addEventListener("pointerdown",pointerDown,{passive:!0}),n.addEventListener("dblclick",()=>{pointers=[];const i=document.getElementById("colorModal"),r=document.getElementById("noteText"),u=document.getElementById("noteColor"),f=document.getElementById("updateNoteSaveButton"),e=()=>{h.hide(),t.text=n.innerText=r.value,t.color=n.style.backgroundColor=u.value,connection.invoke("UpdateNote",id,t)},o=()=>{isModalOpen=!0,r.focus()},s=()=>{isModalOpen=!1,f.removeEventListener("click",e),i.removeEventListener("shown.bs.modal",o),i.removeEventListener("hide.bs.modal",s)};f.addEventListener("click",e);i.addEventListener("shown.bs.modal",o);i.addEventListener("hide.bs.modal",s);r.value=t.text;u.value=t.color;const h=new bootstrap.Modal(i);h.show()}),n.addEventListener("contextmenu",n=>{pointers=[],n.preventDefault(),n.stopPropagation()})},addNote=(n,t)=>{let i={id:generateId(),text:n,color:t,position:{x:100,y:100,rotation:Math.floor(Math.random()*8)-4},width:100,height:100},r=document.createElement("div");createOrUpdateNoteElement(r,i);notesElement.insertBefore(r,notesElement.firstChild);console.log("Calling UpdateNote:");console.log(i);connection.invoke("UpdateNote",id,i).then(function(){console.log("UpdateNote called")}).catch(function(n){console.log("UpdateNote error");console.log(n)})},showNoteDialog=()=>{if(isMove=!1,pointers=[],!isModalOpen){const n=document.getElementById("colorModal"),t=document.getElementById("noteText"),r=document.getElementById("noteColor"),u=document.getElementById("updateNoteSaveButton"),f=()=>{i.hide(),t.value.length!==0&&(addNote(t.value,r.value),i.show())},e=()=>{isModalOpen=!0,t.value="",r.value="lightyellow",t.focus()},o=()=>{isModalOpen=!1,u.removeEventListener("click",f),n.removeEventListener("shown.bs.modal",e),n.removeEventListener("hide.bs.modal",o)};u.addEventListener("click",f);n.addEventListener("shown.bs.modal",e);n.addEventListener("hide.bs.modal",o);const i=new bootstrap.Modal(n);i.show()}};window.addEventListener("focus",()=>{});window.addEventListener("blur",()=>{});window.addEventListener("pointerdown",n=>{deSelectNotes(),pointerDiff=0,pointers.push(n),currentX=n.clientX,currentY=n.clientY,isMove=!0});window.addEventListener("contextmenu",n=>{n.preventDefault(),sourceElement===undefined&&showNoteDialog()});connection.on("notes",function(n){let t="Date received: "+(new Date).toLocaleTimeString();t+="\n"+n.body;addMessage(t)});connection.onclose(function(n){n?addMessage("Connection closed with error: "+n):addMessage("Disconnected")});connection.start().then(function(){connection.invoke("Join",id)}).catch(function(n){addMessage(n)});connection.on("AllNotes",n=>{console.log("Notes:");console.log(n);for(let t=0;t<n.length;t++){const r=n[t],i=document.createElement("div");createOrUpdateNoteElement(i,r);notesElement.insertBefore(i,notesElement.firstChild)}});connection.on("UpdateNote",n=>{console.log("UpdateNote:");console.log(n);let t=document.getElementById(n.id);t===undefined||t==null?(t=document.createElement("div"),createOrUpdateNoteElement(t,n),notesElement.insertBefore(t,notesElement.firstChild)):createOrUpdateNoteElement(t,n)});document.addEventListener("keyup",n=>{if(n.key==="Escape")deSelectNotes(),selectedElement=undefined;else if(n.key!=="Alt"&&n.key!=="Control"&&n.key!=="F12"&&n.key!=="Tab")if(n.key==="Backspace"||n.key==="Delete"){const n=document.getElementsByClassName("selected");while(n.length>0)notesElement.removeChild(n[0]);selectedElement=undefined}else if(n.key==="a"&&n.ctrlKey){deSelectNotes();const n=document.getElementsByClassName("stickynote");for(let t=0;t<n.length;t++)n[t].classList.add("selected")}else n.key==="0"&&n.ctrlKey?(scale=1,notesElement.style.transform=`scale(${scale})`):n.altKey||(console.log(n),showNoteDialog())});